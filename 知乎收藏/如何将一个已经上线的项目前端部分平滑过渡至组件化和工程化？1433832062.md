# 如何将一个已经上线的项目前端部分平滑过渡至组件化和工程化？

泻药，如果接手到一个 全局变量满天飞，没什么模块力度，一个文件上千行，整站就几个js文件，编写毫无章法，模板中内嵌js变量和调用全局方法，模板数量庞大，这种情况，重构确实不好做。  

遇到问题解决问题，我们把复杂的事情抽象一下。这个过渡到底要做什么。  

1，不影响线上项目运行。  
2，代码重构。  
3，引入自动化工具，解决复杂容易出错，并人力吃紧的点。  
4，规范上线流程，前端开发流程。  
5，模块化前端代码，让以后的开发可以像搭积木一样。  

如果以上几点算是共识，那么一条一条解决就好了。市面上的轮子很多，但是还是要找到自己的问题，再找合适的轮子来用。  

1，不影响线上项目运行。  

如何做到呢？我的经验是，不动老的代码，在完成了新架构的设计后，先在新的模板和项目上进行操作。达到不继续“乱”的局面。  

老代码怎么办？这里要说的情况就很复杂了，比如模板中include，全局一个base.js，然后不同组件部分就是一个xxxPlugins({config:{}});这样执行的，我觉得这种还是比较好做的。  

在开始改动之前先上隔离，做好备份和回退机制（理论上应该是先上测试，但是实际情况很难）。然后让后端配合做一个beta版或者叫隔离版，让前端开发工程师可以在这里做老代码重构，一直到结束测试（如果资源不允许，可以转换思路比如纯前端自己做本地代理实现几个重要页面的重构），再让后端配合修改模板。  

这个地方主要还是看实际项目老代码的复杂度，需要根据实际情况来，我曾经重构一个类似的项目使用自己开发的模块加载器，因为项目页面不多，也就10几个不同类型的，手工操作基本1个工作日就完成了。当然老代码写的还是比较规范，这个需要看具体情况和具体代码。  

总之，我的原则就是，老的能不动不要动，如果要动一定要做好隔离，做好回退，并且改之前一定要好好review老代码，理解一下为什么之前这样写。  

2，代码重构。  

分几点吧，模块化工具看团队喜好或者个人喜欢不多说，首先重构的概念无论任何语言都差不多，是有可以遵循的原则的，有些代码是不需要理解他的逻辑就可以进行重构的，详细可以参考这本书[重构 (豆瓣)](http://book.douban.com/subject/4262627/) 里的做法，先把老代码拆分，我们掌握了方法，还需要借助一些辅助工具，我推荐这个：[Refactoring your JavaScript code with Grasp](http://www.graspjs.com/blog/2014/01/07/refactoring-javascript-with-grasp/) 国内的文章比较少，是专门对js代码进行重构的工具，比vim的replace和多数ide的find功能和replace功能要强大，当然还需要结合sed和grep对整个站点的模板进行配合修改。（如果都是js文件还好说，grasp足够，恶心的是方法在模板中被调用，那么就必须也要对所有的模板有修改权限才好）  

重构的目的是让代码可以更好被理解和扩展，然后是组件化目的。我推荐seajs或者自己做cmd管理，至于如何老代码的cmd包装，推荐自己阅读以下seajs的源码，再写个工具，其实很简单，不推荐官方的做法，最适合自己的工具一定是自己磨的（我就是自己磨。。）。  

重构的过程很爽的，相信我，如果资源不允许我会采取新需求来了，增加评估时间来对老代码做改善，能为工程师争取一些时间（新需求是在老代码基础上来做的这种情况）。  

3，自动化。  

不为了自动化而自动化，但是一定要知道人力浪费在哪。不是所有工具都适合自己，首先要学会发现问题才对嘛。。比如上线之前，为了确保团队代码规范，使用git commit pre或者svn commit pre的钩子工具做检查，这是一个很好的方法，再有比如，压缩打包合并一类工作grunt，gulp的解决方案当然也都已经烂大街了，该用就用，我们这边还有一些好玩的做法，比如一个新需求一个branch，打tag是个体力活，自动化之，checkout有很多依赖，我们使用grunt自动checkout相关代码？再或者部署到测试机或者线上cdn，每次都好麻烦？也可以包装成task，攒到一起就是你们的开发规范了。  

而工具真的，不重要。看你能不能快速找到痛点了。更新测试机好麻烦？写个shell？命令行也麻烦？做个web界面？这样其他非前端工程师也能方便部署最新代码了。  

以上这些我都做过，在我眼里都算是自动化了。  

4，上线不要过度自动，有时候该人工还是要人工，比如diff每次上线前的改变，确认按钮，一定要人工。。  
规范问题，我的建议，代码上采取填空式的规范制度。  

什么叫填空式？  

解一道题，我们都是有步骤了，写一段代码也是应该有步骤的，初始化一个构造器对参数做规范，我们应该怎么写？对外的api，必须有哪些方法？我们也是可以提前设计的。我是相信开发的模式化对新人工程师是最大的规范帮助，那些什么tab需要几个，注释应该用什么格式，在我看来没那么重要，我是相信代码是可以说话的，只要你的代码开发起来有强制的模式之后，这些东西都是快速集合在代码里的。  

注释怎么办？老代码一个一个去改好，加注释好麻烦咯。我们能不能开发个读js文件，左右分屏，实时增加注释工具呢？就像diff模式那种，肯定是可以的，我觉得也不麻烦，以后code review还能用的上。  

其他的用commit pre就足够了。  

5，在内部分享过几次前端模块化的基础知识，优缺点都有，未来的趋势我们不好说，目前来看还是比较完善的一种解决方案了。足够简单的api，足够灵活的构建方法，简单的api，简单的规范，我推荐我写的这个工具 [litheModule/lithe · GitHub](https://github.com/litheModule/lithe) 有node的api有前端的api，我们这边用了很久，和seajs差不多。有使用问题可以私信和我交流。这里上传一个我之前培训用到的ppt吧。[<span>http://www.</span><span>slideshare.net/xiaojueq</span><span>q12345/ss-49156712</span><span></span>](http://www.slideshare.net/xiaojueqq12345/ss-49156712) 内容不多，大部分都是我口述，也可以私信和我沟通。  

-----------------------------  

如果真的重构不来，没有资源，无法把老代码改善的很好。  

那么我们至少 可以 新代码 不再写的那么屎。加油。